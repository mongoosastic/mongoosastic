Монгуастичний
=============


Mongoosastic - це плагін [mongoose] (http://mongoosejs.com/), який може автоматично індексувати ваші моделі в [elasesearch] (https://www.elastic.co/).

- [Установка] (# установка)
- [Налаштування] (# налаштування)
- [Індексація] (# індексація)
  - [Збереження документа] (# збереження документа)
  - [Видалення документа] (# видалення-документа)
  - [Індексація вкладених моделей] (# індексація-вкладених моделей)
  - [Індексація посилань на мангустів] (# індексація-мангуста-посилання)
  - [Індексація існуючої колекції] (# індексація-наявна колекція)
  - [Масова індексація] (# об'ємна індексація)
  - [Фільтрована індексація] (# відфільтрована-індексація)
  - [Індексація попиту] (# індексація за запитом)
  - [Скасування вилучення за запитом] (# видалення за запитом)
  - [Обрізання індексу] (# truncating-an-index)
  - [Обмеження] (# обмеження)
    - [Автоіндексація] (# автоматична індексація)
    - [Пошук відразу після es-індексованої події] (# search-відразу-після-es-indexed-event)
- [Картографування] (# відображення)
  - [Географічне відображення] (# географічне відображення)
    - [Індексація геоточки] (# індексація-гео-точка)
    - [Індексація геофігури] (# індексація-гео-форма)
  - [Створення відображень за запитом] (# створення-відображення на вимогу)
- [Запити] (# запитів)
  - [Гідратація] (# гідратація)

## Встановлення

Остання версія цього пакета буде максимально наближена до найновіших пакетів `elasticsearch` та` mongoose`.

`` `баш
npm встановити -S монгоосастичний
`` `

## Налаштування

### Model.plugin (монгоосастика, параметри)

Варіанти:

* `index` - індекс у Elasticsearch для використання. За замовчуванням плюралізація назви моделі.
* `type` - тип, який ця модель представляє в Elasticsearch. За замовчуванням назва моделі.
* `esClient` - існуючий екземпляр Elasticsearch` Client`.
* `hosts '- масив хостів Elasticsearch працює на.
* `host` - хост Elasticsearch працює на
* `port` - порт Elasticsearch працює на
* `auth` - автентифікація, необхідна для досягнення сервера Elasticsearch. У стандартному форматі "ім'я користувача: пароль"
* `Protocol '- протокол, який використовує сервер Elasticsearch. За замовчуванням http
* `гідрат '- чи потрібно шукати результати в mongodb раніше
* `hydrateOptions '- параметри переходу у гідратну функцію
* `bulk` - параметри розміру та затримки для масової індексації
* `filter` - функція, яка використовується для відфільтрованої індексації
* `перетворення '- функція, що використовується для перетворення серіалізованого документа перед індексуванням
* `populate '- масив об'єктів параметрів для заповнення масиву мангустів
* `indexAutomatically '- дозволяє відключити індексацію після збереження моделі, коли вам потрібен більш тонкий контроль, коли документи індексуються. Значення за замовчуванням - справжнє
* `customProperties` - об'єкт, що деталізує додаткові властивості, які будуть об'єднані на відображення за замовчуванням типу, коли викликається` createMapping '.
* `saveOnSynchronize` - запускає метод мангуста збереження (і попереднього збереження) при синхронізації колекції / індексу. Значення за замовчуванням - справжнє


Щоб модель була індексована в Elasticsearch, просто додайте плагін.

`` javascript
var mongoose = вимагати ('мангуста')
  , mongoosastic = вимагати ('mongoosastic')
  , Схема = мангуста.Схема

var User = нова схема ({
    назва: Рядок
  , електронна пошта: String
  , місто: Рядок
})

User.plugin (монгоосастичний)
`` `

Це за замовчуванням просто використовуватиме плюралізацію назви моделі як індексу
при використанні в якості типу самої назви моделі. Тож якщо ви створите нове
Користувальницький об’єкт і збережіть його, ви можете побачити його, перейшовши до
http: // localhost: 9200 / users / user / _search (це передбачає, що Elasticsearch є
працює на порту 9200).

Поведінка за замовчуванням - всі поля індексуються в Elasticsearch. Це може бути трохи марно, особливо враховуючи це
документ зараз просто дублюється між mongodb та
Elasticsearch, тож вам слід подумати про вибір індексувати лише певні поля, вказавши на es_indexed
поля, які потрібно зберегти:


`` javascript
var User = нова схема ({
    ім'я: {тип: Рядок, es_indexed: true}
  , електронна пошта: String
  , місто: Рядок
})

User.plugin (монгоосастичний)
`` `

У цьому випадку для пошуку буде індексовано лише поле імені.

Тепер, додавши плагін, модель матиме новий метод під назвою
"пошук", який можна використовувати для спрощення складних пошуків. "Пошук"
метод приймає [стандартний запит Elasticsearch DSL] (https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-queries.html)

`` javascript
User.search ({
  query_string: {
    запит: "john"
  }
}, функція (помилка, результати) {
  // результати тут
});

`` `

Щоб підключитися до декількох хостів, ви можете використовувати масив хостів.

`` javascript
MyModel.plugin (монгоосастичний, {
  господарі: [
    'localhost: 9200',
    'інший господар: 9200'
  ]
})
`` `

Також ви можете повторно використовувати наявний екземпляр Elasticsearch `Client`

`` javascript
var esClient = новий гумовий пошук.Client ({хост: 'localhost: 9200'});
MyModel.plugin (монгоосастичний, {
  esClient: esClient
})
`` `


## Індексація

### Збереження документа
Індексація відбувається після збереження в mongodb і є відкладеним процесом.
Можна перевірити кінець індексації, зафіксувавши ес-індексовану подію.

`` javascript
doc.save (функц.)n (помилка) {
  if (err) кинути err;
  / * Індексація документів, що продовжуються * /
  doc.on ('es-indexed', function (помилка, res) {
    if (err) кинути err;
    / * Документ індексується * /
    });
  });
`` `

### Видалення документа
Видалення документа або його видалення відбувається, коли документ видаляється за допомогою виклику `.remove ()` в екземплярі документа мангуста.
Можна перевірити кінець деіндексації, зафіксувавши подію es-remove.

`` javascript
doc.remove (функція (помилка) {
  if (err) кинути err;
  / * Вилучення документа у фоновому режимі * /
  doc.on ('es-remo', функція (помилка, res) {
    if (err) кинути err;
    / * Docuemnt неприєднаний * /
  });
});
`` `

Зауважте, що використання `Model.remove` не включає документи мангуста, як зазначено в [документації] (http://mongoosejs.com/docs/api.html#model_Model.remove). Тому наступне не скасовує документ.

`` javascript
MyModel.remove ({_id: doc.id}, функція (помилка) {
  / * doc залишається в кластері Elasticsearch * /
});
`` `

### Індексація вкладених моделей
Для індексації вкладених моделей ви можете навести наступний приклад.

`` javascript
var Коментар = нова схема ({
    назва: Рядок
  , корпус: Рядок
  , автор: Рядок
})


var User = нова схема ({
    ім'я: {тип: Рядок, es_indexed: true}
  , електронна пошта: String
  , місто: Рядок
  , коментарі: {type: [коментар], es_indexed: true}
})

User.plugin (монгоосастичний)
`` `

### Elasticsearch [Вкладений тип даних] (https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html)
Оскільки за замовчуванням у Elasticsearch є взяття масивів і згладжування їх в об'єкти,
може важко писати запити, де потрібно підтримувати стосунки
між об'єктами в масиві, per.
Спосіб зміни такої поведінки полягає у зміні типу Elasticsearch від `object`
(мангоосастичний за замовчуванням) до `вкладеного`

`` javascript
var Коментар = нова схема ({
    назва: Рядок
  , корпус: Рядок
  , автор: Рядок
})


var User = нова схема ({
    ім'я: {тип: Рядок, es_indexed: true}
  , електронна пошта: String
  , місто: Рядок
  , коментарі: {
      тип: [коментар],
      es_indexed: правда,
      es_type: 'вкладений',
      es_include_in_parent: вірно
  }
})

User.plugin (монгоосастичний)
`` `

### Індексація посилань мангустів
Для того, щоб індексувати посилання мангуста, ви можете навести наступний приклад.

`` javascript
var Коментар = нова схема ({
    назва: Рядок
  , корпус: Рядок
  , автор: Рядок
});


var User = нова схема ({
    ім'я: {тип: Рядок, es_indexed: true}
  , електронна пошта: String
  , місто: Рядок
  , коментарі: {type: Schema.Types.ObjectId, ref: 'Коментар',
    es_schema: коментар, es_indexed: правда, es_select: 'body title'}
})

User.plugin (mongoosastic, {
  заповнювати: [
    {шлях: "коментарі", виберіть: "тіло заголовка"}
  ]
})
`` `
У схемі вам потрібно буде вказати поле `es_schema` - посилається схема.
За замовчуванням кожне поле згаданої схеми буде відображено у картографічному режимі. Використовуйте поле `es_select`, щоб вибрати лише певні поля.

`populate` - це масив об'єктів параметрів, до яких ви зазвичай переходите
[Model.populate] (http://mongoosejs.com/docs/api.html#model_Model.populate).

### Індексація існуючої колекції
Вже є колекція mongodb, яку ви хочете проіндексувати, використовуючи цю функцію
підключати? Нема проблем! Просто зателефонуйте до методу синхронізації на вашій моделі
відкрийте потік мангуста і почніть індексувати документи окремо.

`` javascript
var BookSchema = нова схема ({
  назва: Рядок
});
BookSchema.plugin (мангустатичний);

var Book = mongoose.model ("Книга", BookSchema)
  , stream = Book.synchronize ()
  , рахувати = 0;

stream.on ('дані', функція (помилка, документ) {
  рахувати ++;
});
stream.on ('закрити', функція () {
  console.log ('індексований' + count + 'документи!');
});
stream.on ('помилка', функція (помилка) {
  console.log (помилка);
});
`` `

Ви також можете синхронізувати підмножину документів на основі запиту!

`` javascript
var stream = Book.synchronize ({автор: 'Артур К. Кларк'})
`` `

А також із зазначенням параметрів синхронізації

`` javascript
var stream = Book.synchronize ({}, {saveOnSynchronize: true})
`` `

Варіанти:

 * `saveOnSynchronize` - запускає метод мангуста збереження (і попереднього збереження) при синхронізації колекції / індексу. За замовчуванням використовується глобальна опція `saveOnSynchronize`


### Масова індексація

Ви також можете вказати опції `bulk` з мангустом, які використовуватимуть оптові індексації масивів Elasticsearch. Це призведе до того, що функція "синхронізувати" також використовувати масове індексування.

Mongoosastic зачекає 1 секунду (або вказану затримку), поки вона не набере 1000 документів (або вказаний розмір), а потім виконає масове індексування.

`` javascript
BookSchema.plugin (mongoosastic, {
  оптом: {
    розмір: 10, // бажана кількість документів для масового індексу
    затримка: 100 // мілісекунд, щоб чекати достатньої кількості документів, щоб задовольнити обмеження розміру
  }
});
`` `

### Фільтрована індексація

Ви можете вказати функцію фільтра, щоб індексувати модель в Elasticsearch на основі деяких конкретних умов.

Функція фільтрації повинна повернути True для умов, які ігнорують індексацію Elasticsearch.

`` javascript
var MovieSchema = нова схема ({
  назва: {type: String},
  жанр: {тип: String, enum: ['жах "," дія "," пригода "," інше "]}
});MovieSchema.plugin (монгоосастичний, {
  фільтр: функція (док) {
    return doc.genre === 'дія';
  }
});
`` `

Екземпляри моделі фільму, що мають "дії" як свій жанр, не індексуються на Elasticsearch.


### Індексація за запитом
Ви можете робити індекси на вимогу за допомогою функції `index`

`` javascript
Dude.findOne ({name: 'Jeffrey Lebowski', функція (помилка, чувак) {
  dude.awesome = правда;
  dude.index (функція (помилка, res) {
    console.log ("egads! Мене індексували!");
  });
});
`` `

Метод індексу бере 2 аргументи:

* `options '(необов'язково) - {index, type} - індекс та тип для публікації. Типово встановлений стандартний індекс та введіть його
  модель була налаштована.
* `зворотний дзвінок` - функція зворотного дзвінка, яку потрібно викликати, коли документ був
  індексований.

Зауважте, що індексація моделі не означає, що вона буде зберігатися
mongodb. Використовуйте для цього збереження.

### Скасування видалення даних на вимогу
Ви можете видалити документ із кластера Elasticsearch за допомогою функції `unIndex`.

`` javascript
doc.unIndex (функція (помилка) {
  console.log ("Мене видалено з кластеру :(");
});
`` `

Метод unIndex бере 2 аргументи:

* `options '(необов'язково) - {index, type} - індекс та тип для публікації. Типово встановлений стандартний індекс та введіть його
  модель була налаштована.
* `зворотний виклик` - функція зворотного дзвінка, яку потрібно викликати, коли модель була
  непридатний.


### Обрізання індексу

Статичний метод `esTruncate` видалить усі документи із пов'язаного індексу. Цей метод у поєднанні з функцією `синхронізувати () 'може бути корисним у разі тестів інтеграції, наприклад, коли кожен тестовий випадок потребує очищеного індексу в Elasticsearch.

`` javascript
GarbageModel.esTruncate (функція (помилка) {...});
`` `

### Обмеження

#### Автоматична індексація

Mongoosastic намагається автоматично індексувати документи на користь функції [середнього програмного забезпечення] (http://mongoosejs.com/docs/middleware.html) мангусти.

Mongoosastic автоматично індексує, коли `document.save` /` Model.findOneAndUpdate` / `Model.insertMany` /` document.remove` / `Model.findOneAndRemove`, але не включає` Model.remove` / `Model.update`.

І ви повинні мати параметри `new: true`, коли` findOneAndUpdate ', щоб монгоосастик міг отримати нові значення в пост-гачку.

#### Пошук відразу після події, індексованої ес

> Elasticsearch за замовчуванням оновлює кожен фрагмент кожні 1 секунди, тому документ буде доступний для пошуку 1 після його індексації.

Подія `es-indexed 'означає, що еластичний пошук отримав запит на індекс, і якщо ви хочете шукати документ, будь ласка, спробуйте через 1s. Див. [Документ не знайдено одразу після його збереження] (https://github.com/elastic/elasticsearch-js/isissue/231)

## Картографування

Схеми можуть бути налаштовані на спеціальні параметри для кожного поля. Ці збіги
з існуючими [конфігураціями відображення поля] (https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html), визначеними Elasticsearch, з тією лише різницею, що всі вони мають префікс "es_ ".

Так, наприклад. Якщо ви хотіли проіндексувати модель книги та мати імпульс
для заголовка встановлено на 2,0 (надаючи йому більший пріоритет під час пошуку)
визначте його так:

`` javascript
var BookSchema = нова схема ({
    назва: {тип: String, es_boost: 2.0}
  , автор: {type: String, es_null_value: "Невідомий автор"}
  , дата публікації: {тип: Дата, es_type: 'дата'}
});

`` `
У цьому прикладі використовується кілька інших полів відображення ... таких як null_value та
type (який замінює будь-яке значення типу схеми, корисно, якщо ви
хочете сильнішого набору тексту, наприклад, float).

Існують різні варіанти відображення, які можна визначити в Elasticsearch. Перевірте [https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.htmlSense(https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping. html) для отримання додаткової інформації. Ось приклади до можливих на сьогодні визначень у монгоосастиці:

`` javascript
var ExampleSchema = нова схема ({
  // Рядок (тип основного)
  рядок: {type: String, es_boost: 2.0},

  // Число (тип основного)
  номер: {type: Number, es_type: 'integer'},

  // Дата (тип основного)
  дата: {тип: Дата, es_type: 'дата'},

  // Тип масиву
  масив: {тип: масив, es_type: 'string'},

  // Тип об’єкта
  об’єкт: {
    field1: {type: String},
    field2: {type: String}
  },

  // Вкладений тип
  вкладено: [SubSchema],

  // Багатопольовий тип
  multi_field: {
    тип: Рядок,
    es_type: 'multi_field',
    es_fields: {
      multi_field: {type: 'string', index: 'analysed'},
      недоторкані: {type: 'string', index: 'not_analyzed'}
    }
  },

  // Тип географічної точки
  гео: {
    тип: Рядок,
    es_type: 'гео_точка'
  },

  // Тип гео-точки з полями lat_lon
  geo_with_lat_lon: {
    geo_point: {
      тип: Рядок,
      es_type: 'geo_point',
      es_lat_lon: вірно
    },
    lat: {type: Number},
    lon: {тип: номер}
  }

  geo_shape: {
    координати: [],
    type: {type: String},
    geo_shape: {
      тип: Рядок,
      es_type: "гео_шапе",
      es_tree: "чотири",
      es_precision: "1 км"
    }
  }

  // Особливість: вкажіть метод лиття для попередньої обробки поля перед його індексуванням
  someFieldToCast:{select: 'вік імені'}
  },
  функція (помилка, результати) {
    // результати тут
});

`` `

Оригінальні дані результатів ElasticSearch можна зберігати за допомогою параметра "hydrateWithESResults". Потім документи покращуються за допомогою a
властивість `_esResult`

`` javascript

User.search (
  {query_string: {query: 'john'}},
  {
    гідрат: правда,
    hydrateWithESResulta: true,
    hydrateOptions: {select: 'ім'я віку'}
  },
  функція (помилка, результати) {
    // результати тут
    results.hits.hits.forEach (функція (результат) {
      console.log (
        "оцінка",
        result._id,
        result._esResult._score
      );
    });
});

`` `

За замовчуванням документ `_esResult._source` пропускається. Його можна додати за допомогою параметра `hydrateWithESResults: {source: false}`.



Зауважте, що використання гідрату буде на ступінь повільніше, оскільки воно буде виконувати Elasticsearch
запит, а потім зробіть запит проти mongodb для всіх повернених ідентифікаторів
результати пошуку.

Ви також можете встановити це за замовчуванням, щоб це завжди було, надавши його як а
опція плагіна (а також налаштування параметрів гідратів за замовчуванням):


```javascript
var User = new Schema({
    name: {type:String, es_indexed:true}
  , email: String
  , city: String
})

User.plugin (mongoosastic, {hydrate: true, hydrateOptions: {lean: true}})
`` `
